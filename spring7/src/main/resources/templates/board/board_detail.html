<!DOCTYPE html>
<html lang="ko" xmlns:th="http://thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆ ê¸€ì“°ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/detail.css}">
    <script th:src="@{/script/jquery-3.7.1.min.js}"></script>
    <script>
        $(function () {
            init();
            $("#comment-register").on('click', writeComment);
            $(".like_emoji").on('click', increaseLike);

            // ëª¨ë“  ëŒ“ê¸€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ 
            function init() {
                let contextPath = $("#contextPath").val();
                let boardNum = $("#boardNum").val();
                $.ajax({
                    url: contextPath + '/comment/allComments'
                    , method: 'GET'
                    , data: { "boardNum": boardNum }
                    , success: function (resp) {
                        $.each(resp, function (index, item) {
                            commentOutput(item);
                        })
                    }
                })

            }

            function writeComment() {
                let boardNum = $("#boardNum").val();
                let commentWriter = $("#loginId").val(); //$("#commentWriter").attr("text");
                let commentText = $("#commentText").val();
                let contextPath = $("#contextPath").val();
                if (commentText.trim().length == 0) {
                    alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.")
                    $("#commentText").focus();
                    return;
                }

                // POST, url: /comment/commentInsert, ìš”ì²­ë°ì´í„°: ì‘ì„±ì, ëŒ“ê¸€ ë‚´ìš©, ê²Œì‹œê¸€ ë²ˆí˜¸
                $.ajax({
                    url: contextPath + '/comment/insertComment'
                    , method: 'POST'
                    , data: {
                        "boardNum": boardNum, "commentWriter": commentWriter,
                        "commentText": commentText
                    }
                    , success: commentOutput
                })
            };

            function commentOutput(resp) {
                let loginId = $("#loginId").val();
                let result = `
                <li class="comment_item">
                    <div class="comment_area">
                        <span class="comment_writer" style="color: rgb(70, 69, 69); font-size: small;">${resp["commentWriter"]}</span>
                        <span class="comment_create_date" style="color: rgb(70, 69, 69); font-size: smaller;">${resp["createDate"]}</span>
                        <br>
                        <div class="comment_text_box">
                            <p class="comment_text">${resp["commentText"]}</p>
                        </div>`
                if (loginId == resp["commentWriter"]) {
                    result += `<div class="button_area" th:if="${loginId == resp["commentWriter"]}">
                            <input type="button" class="updateBtn" value="ìˆ˜ì •" data-no=${resp["commentNum"]}>
                            <input type="button" class="delBtn" value="ì‚­ì œ" data-no=${resp["commentNum"]}>
                        </div>`
                };

                result += `</div>
                                    <hr>
                                </li>
                                `
                // // ë¡œê·¸ì¸ ì•„ì´ë””ì™€ ëŒ“ê¸€ì“´ì´ì˜ ì•„ì´ë””ê°€ ê°™ìœ¼ë©´ 
                // if ($("#loginId") == item.commentWriter); // allala... 

                $("ul.comment_list").append(result);
                $(".delBtn").on('click', deleteComment);
            }

            function deleteComment() {
                let commentNum = $(this).attr("data-no");
                let contextPath = $("#contextPath").val();
                $.ajax({
                    url: contextPath + '/comment/deleteComment'
                    , method: 'GET'
                    , data: { "commentNum": commentNum }
                    , success: function () {
                        alert("ëŒ“ê¸€ì´ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! :)");
                    }
                })

                $(this).parent().parent().parent().remove();
            }

            // ì¢‹ì•„ìš” ë²„íŠ¼ ë™ì‘
            function increaseLike() {
                let boardNum = $("#boardNum").val();
                let contextPath = $("#contextPath").val();

                $.ajax({
                    url: contextPath + '/board/increaseLike'
                    , method: "GET"
                    , data: { "boardNum": boardNum }
                    , success: function (resp) {
                        $(".like_count").text(resp);
                    }
                });
            }
        });
    </script>
</head>

<body>
    <div class="header">
        <div class="logo">
            <a th:href="@{/}"><img th:src="@{/images/jindo_logo.png}" alt="logo"></a>
            <h2>ê²Œì‹œê¸€ ë³´ê¸°</h2>
        </div>
    </div>

    <div class="container">
        <table border="1">
            <tr>
                <th>ì‘ì„±ì</th>
                <td>
                    <span th:text="${board.boardWriter}">ì‘ì„±ì</span>
                </td>
            </tr>
            <tr>
                <th>ê¸€ ì œëª©</th>
                <td>
                    <span th:text="${board.boardTitle}">ê¸€ì œëª©</span>
                </td>
            </tr>
            <tr>
                <th>ì‘ì„±ì¼</th>
                <td>
                    <span th:text="${#temporals.format(board.createDate, 'yy-MM-dd HH:mm:ss')}">ì‘ì„±ì¼</span>
                </td>
            </tr>
            <tr>
                <th>ìˆ˜ì •ì¼</th>
                <td>
                    <span th:text="${#temporals.format(board.updateDate, 'yy-MM-dd HH:mm:ss')}">ìˆ˜ì •ì¼</span>
                </td>
            </tr>
            <tr>
                <th>ì²¨ë¶€íŒŒì¼</th>
                <td>
                    <span><a th:href="@{/board/download(boardNum=${board.boardNum})}"
                            th:text="${board.originalFileName}"></a></span>
                </td>
            </tr>
            <tr>
                <th>ê¸€ ë‚´ìš©</th>
                <td>
                    <!-- ì…ë ¥í•œ ê·¸ëŒ€ë¡œ ì¶œë ¥ -->
                    <pre>[[ ${board.boardContent} ]]</pre>
                </td>
            </tr>
        </table>
        <span class="like_emoji">ğŸ©·</span>
        <em class="like_txt_label">ì¢‹ì•„ìš”</em>&nbsp;<em class="like_count" th:text="${board.likeCount}"></em>
        <div class="buttons">
            <!-- <a href="" class="btn btn-write">ì‚­ì œ</a> -->
            <!-- ì‚­ì œ, ìˆ˜ì •ë²„íŠ¼: ì‘ì„±ìì™€ ë¡œê·¸ì¸í•œ ìœ ì €ê°€ ê°™ì€ ê²½ìš°ì—ë§Œ ë…¸ì¶œ -->
            <!-- authentication.name: LoginUserDetailsì—ì„œ ë°˜í™˜ -->
            <th:block th:if="${board.boardWriter == #authentication.name}"> <!-- th:block: ì½”ë“œê°€ í•´ì„ë˜ê³  ë‚˜ë©´ ì‚¬ë¼ì§ -->
                <a th:href="@{/board/boardDelete(boardNum=${board.boardNum}, searchFilter=${searchFilter}, searchKeyword=${searchKeyword})}"
                    class="btn btn-delete">ì‚­ì œ</a>
                <a th:href="@{/board/boardUpdate(boardNum=${board.boardNum}, searchFilter=${searchFilter}, searchKeyword=${searchKeyword})}"
                    class="btn btn-update">ìˆ˜ì •</a>
            </th:block>


            <a th:href="@{/board/boardList(searchFilter=${searchFilter}, searchKeyword=${searchKeyword})}"
                class="btn btn-list">ëª©ë¡</a>
        </div>
        <div class="searchFilter">
            <input type="hidden" name="searchFilter" th:value="${searchFilter}">
            <input type="hidden" name="searchKeyword" th:value="${searchKeyword}">
        </div>
    </div>
    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <input type="hidden" id="boardNum" th:value="${board.boardNum}">
    <input type="hidden" id="contextPath" th:value="${contextPath}"> <!--contextPath ë³€ìˆ˜ì— ì €ì¥ëœ contextPathê°’ì„ ê°€ì§€ê³ ì˜´-->
    <input type="hidden" id="loginId" th:value="${#authentication.name}">
    <!-- or Controllerì—ì„œ ì„¸ì…˜ì— ì €ì¥ëœ ë¡œê·¸ì¸ ì•„ì´ë””ë¥¼ Modelì— í•¨ê»˜ ì „ë‹¬ -->
    <div class="container">
        <!-- ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥ -->
        <div class="commentBox">
            <ul class="comment_list">
            </ul>
        </div>
        <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê°€ëŠ¥ -->
        <div class="writeComment" sec:authorize="isAuthenticated()">
            <div class="comment-info">
                <span id="commentWriter" style="color: rgb(70, 69, 69); font-size: small;"
                    th:text="${#authentication.name}"></span>
                &nbsp;
                <span id="createDate" style="color: rgb(70, 69, 69); font-size: smaller;">ë‚ ì§œ ë„£ì„ê±°ì„</span>
            </div>
            <div class="comment-write">
                <textarea name="commentText" id="commentText" cols="50" rows="5" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                <input type="button" class="btn btn-update" id="comment-register" value="ë“±ë¡">
            </div>
        </div>
    </div>


</body>

</html>